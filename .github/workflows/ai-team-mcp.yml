name: AI Team Together.ai
on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Describe what you want AI Team to build'
        required: true
        default: 'Create a modern landing page'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  checks: write
  statuses: write

jobs:
  ai-team-together:
    runs-on: ubuntu-latest
    name: ğŸ¤– AI Team Together.ai
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Setup Git
        run: |
          git config --global user.name "AI Team Together.ai"
          git config --global user.email "ai-team-together@github-actions.local"
          
      - name: ğŸ¤– Run AI Team Together.ai
        id: ai_team
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOGETHER_AI_API_KEY: ${{ secrets.TOGETHER_AI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title || github.event.inputs.task_description }}
          ISSUE_BODY: ${{ github.event.issue.body || 'Create modern code' }}
        run: |
          # VÃ©rifier que la clÃ© API Together.ai est configurÃ©e
          if [ -z "$TOGETHER_AI_API_KEY" ]; then
            echo "âŒ ERREUR: Secret TOGETHER_AI_API_KEY non configurÃ©!"
            echo ""
            echo "ğŸ“‹ SOLUTION:"
            echo "1. Allez dans Settings â†’ Secrets and variables â†’ Actions"
            echo "2. CrÃ©ez un nouveau secret repository"
            echo "3. Nom: TOGETHER_AI_API_KEY"
            echo "4. Valeur: 7b61ccee2b0b0f9d4b842862034eea9b18c5e4e26728ef8714b581c0cf0c91fe"
            echo "5. Relancez ce workflow"
            echo ""
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "error=Missing TOGETHER_AI_API_KEY secret" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Together.ai API key configured"
          
          # Install Python dependencies
          pip install requests python-dotenv typing-extensions
          
          chmod +x .github/scripts/ai_team_mcp.py
          python3 .github/scripts/ai_team_mcp.py
          
      - name: ğŸŒ¿ Create Branch and Push
        if: steps.ai_team.outputs.changes_made == 'true'
        run: |
          BRANCH_NAME="${{ steps.ai_team.outputs.branch_name }}"
          git checkout -b $BRANCH_NAME
          git add -A
          git commit -m "ğŸ¤– ${{ steps.ai_team.outputs.agent }}: ${{ steps.ai_team.outputs.task_summary }}"
          git push origin $BRANCH_NAME
          
      - name: ğŸ”„ Create Pull Request
        if: steps.ai_team.outputs.changes_made == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.ai_team.outputs.branch_name }}"
          AGENT="${{ steps.ai_team.outputs.agent }}"
          SUMMARY="${{ steps.ai_team.outputs.task_summary }}"
          FILES="${{ steps.ai_team.outputs.files_created }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          
          PR_TITLE="ğŸ¤– $AGENT: $SUMMARY"
          
          echo "ğŸ¤– Pull Request gÃ©nÃ©rÃ©e par AI Team Together.ai" > pr_body.txt
          echo "" >> pr_body.txt
          echo "Agent IA: $AGENT" >> pr_body.txt
          if [ -n "$ISSUE_NUM" ]; then
            echo "Issue: #$ISSUE_NUM" >> pr_body.txt
          else
            echo "Issue: Manual task" >> pr_body.txt
          fi
          echo "" >> pr_body.txt
          echo "Description: $SUMMARY" >> pr_body.txt
          echo "Fichiers crÃ©Ã©s: $FILES" >> pr_body.txt
          echo "" >> pr_body.txt
          echo "Technologie: Together.ai + AI Team Orchestrator" >> pr_body.txt
          echo "" >> pr_body.txt
          echo "CrÃ©Ã©e automatiquement par AI Team Orchestrator + Together.ai" >> pr_body.txt
          
          if [ -n "$ISSUE_NUM" ]; then
            echo "" >> pr_body.txt
            echo "Closes #$ISSUE_NUM" >> pr_body.txt
          fi
          
          gh pr create --title "$PR_TITLE" --body-file pr_body.txt --head "$BRANCH_NAME" --base main
          rm pr_body.txt
          
      - name: ğŸ’¬ Comment Success
        if: steps.ai_team.outputs.changes_made == 'true' && github.event.issue.number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const agent = '${{ steps.ai_team.outputs.agent }}';
            const branchName = '${{ steps.ai_team.outputs.branch_name }}';
            
            let commentBody = 'ğŸ‰ Pull Request crÃ©Ã©e avec Together.ai !\n\n';
            commentBody += 'Agent utilisÃ©: ' + agent + '\n';
            commentBody += 'Branche: ' + branchName + '\n\n';
            commentBody += 'Prochaines Ã©tapes:\n';
            commentBody += '1. Review le code gÃ©nÃ©rÃ© dans la PR\n';
            commentBody += '2. Tester les fonctionnalitÃ©s\n';
            commentBody += '3. Merger la PR si approuvÃ©\n\n';
            commentBody += 'AI Team Orchestrator v1.4.3 + Together.ai';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
            
      - name: ğŸ’¬ Comment No Changes
        if: steps.ai_team.outputs.changes_made != 'true' && github.event.issue.number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ERROR: ${{ steps.ai_team.outputs.error }}
          AGENT: ${{ steps.ai_team.outputs.agent }}
          TASK_SUMMARY: ${{ steps.ai_team.outputs.task_summary }}
        run: |
          if [[ "$ERROR" == *"Missing TOGETHER_AI_API_KEY"* ]]; then
            echo "## âŒ Configuration manquante" > comment.md
            echo "" >> comment.md
            echo "**ProblÃ¨me:** La clÃ© API Together.ai n'est pas configurÃ©e." >> comment.md
            echo "" >> comment.md
            echo "**ğŸ“‹ Solution:**" >> comment.md
            echo "1. Allez dans \`Settings\` â†’ \`Secrets and variables\` â†’ \`Actions\`" >> comment.md
            echo "2. Cliquez sur \`New repository secret\`" >> comment.md
            echo "3. **Nom:** \`TOGETHER_AI_API_KEY\`" >> comment.md
            echo "4. **Valeur:** \`7b61ccee2b0b0f9d4b842862034eea9b18c5e4e26728ef8714b581c0cf0c91fe\`" >> comment.md
            echo "5. Cliquez \`Add secret\`" >> comment.md
            echo "6. Relancez ce workflow" >> comment.md
            echo "" >> comment.md
            echo "**ğŸ’¡ Aide:** Together.ai est gratuit et utilise des modÃ¨les open source (Llama + CodeLlama)." >> comment.md
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "*AI Team Orchestrator v1.4.3 - Configuration requise*" >> comment.md
          elif [ -n "$ERROR" ]; then
            echo "## âŒ Erreur AI Team" > comment.md
            echo "" >> comment.md
            echo "**ProblÃ¨me rencontrÃ©:** $ERROR" >> comment.md
            echo "" >> comment.md
            echo "**ğŸ” Diagnostic:**" >> comment.md
            echo "- VÃ©rifiez la configuration des secrets GitHub" >> comment.md
            echo "- Consultez les logs dans l'onglet Actions" >> comment.md
            echo "" >> comment.md
            echo "**ğŸ’¡ Aide:**" >> comment.md
            echo "- Essayez de relancer le workflow" >> comment.md
            echo "- VÃ©rifiez que Together.ai est bien configurÃ©" >> comment.md
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "*AI Team Orchestrator v1.4.3 - Erreur dÃ©tectÃ©e*" >> comment.md
          else
            echo "## ğŸ¤– AI Team a analysÃ© votre demande" > comment.md
            echo "" >> comment.md
            echo "**Agent assignÃ©:** $AGENT" >> comment.md
            echo "**TÃ¢che:** $TASK_SUMMARY" >> comment.md
            echo "" >> comment.md
            echo "âš ï¸ **Aucun fichier gÃ©nÃ©rÃ©**" >> comment.md
            echo "" >> comment.md
            echo "L'agent a analysÃ© mais n'a pas crÃ©Ã© de fichiers." >> comment.md
            echo "" >> comment.md
            echo "**ğŸ’¡ Suggestions:**" >> comment.md
            echo "- Reformulez de maniÃ¨re plus spÃ©cifique" >> comment.md
            echo "- PrÃ©cisez le type de code souhaitÃ©" >> comment.md
            echo "- Ajoutez des dÃ©tails techniques" >> comment.md
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "*AI Team Orchestrator v1.4.3 avec Together.ai*" >> comment.md
          fi
          
          gh issue comment ${{ github.event.issue.number }} --body-file comment.md
          
      - name: ğŸ‰ Summary
        run: |
          echo "ğŸ¤– AI Team Together.ai completed!"
          echo "Agent: ${{ steps.ai_team.outputs.agent }}"
          echo "Task: ${{ steps.ai_team.outputs.task_summary }}"
          echo "Changes: ${{ steps.ai_team.outputs.changes_made }}" 