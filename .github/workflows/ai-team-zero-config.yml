name: AI Team Zero-Config
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Describe what you want AI Team to build'
        required: true
        default: 'Create a modern landing page'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-team-orchestrator:
    runs-on: ubuntu-latest
    name: ğŸ¤– AI Team Orchestrator
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Setup Git identity
        run: |
          git config --global user.name "AI Team Bot"
          git config --global user.email "ai-team@github-actions.local"
          
      - name: ğŸ” Analyze Task
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title || github.event.inputs.task_description }}
          ISSUE_BODY: ${{ github.event.issue.body || 'Manual task execution' }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          MANUAL_TASK: ${{ github.event.inputs.task_description || '' }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          ACTION: analyze
        run: |
          chmod +x .github/scripts/zero_config_generator.py
          python3 .github/scripts/zero_config_generator.py
          
      - name: ğŸš€ Generate Code
        id: generate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASK: ${{ steps.analyze.outputs.task }}
          TASK_TYPE: ${{ steps.analyze.outputs.task_type }}
          AGENT: ${{ steps.analyze.outputs.agent }}
          ACTION: generate
        run: |
          python3 .github/scripts/zero_config_generator.py
          
      - name: ğŸ“ Apply Changes
        id: apply
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION: apply
        run: |
          python3 .github/scripts/zero_config_generator.py
          
      - name: ğŸŒ¿ Create Branch and Commit
        id: create_pr
        if: steps.apply.outputs.changes_made == 'true'
        run: |
          # CrÃ©er un nom de branche unique
          BRANCH_NAME="ai-team/issue-${{ github.event.issue.number || 'manual' }}-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # CrÃ©er et switch vers la nouvelle branche
          git checkout -b $BRANCH_NAME
          
          # Ajouter les fichiers gÃ©nÃ©rÃ©s
          git add -A
          
          # Commiter les changements
          git commit -m "ğŸ¤– AI Team: ${{ steps.analyze.outputs.task_summary }}
          
          Generated by: ${{ steps.analyze.outputs.agent }}
          Files created: ${{ steps.apply.outputs.files_created }}
          
          Auto-generated from issue #${{ github.event.issue.number || 'manual-task' }}"
          
          # Pousser la branche
          git push origin $BRANCH_NAME
          
      - name: ğŸ”„ Create Pull Request
        if: steps.apply.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¤– AI Team: ${{ steps.analyze.outputs.task_summary }}',
              head: '${{ steps.create_pr.outputs.branch_name }}',
              base: context.ref.replace('refs/heads/', ''),
              body: `## ğŸ¤– Pull Request gÃ©nÃ©rÃ©e par AI Team
              
              **Agent:** ${{ steps.analyze.outputs.agent }}
              **Issue:** #${{ github.event.issue.number || 'N/A' }}
              
              ### ğŸ“ Description
              ${{ steps.analyze.outputs.task_summary }}
              
              ### ğŸ“ Fichiers crÃ©Ã©s
              ${{ steps.apply.outputs.files_created }}
              
              ### âœ… Tests automatiques
              - [ ] Code gÃ©nÃ©rÃ© avec succÃ¨s
              - [ ] Fichiers crÃ©Ã©s correctement
              - [ ] PrÃªt pour review
              
              ---
              *Cette PR a Ã©tÃ© crÃ©Ã©e automatiquement par AI Team Orchestrator*
              
              Closes #${{ github.event.issue.number }}`
            });
            
            console.log(`Pull Request crÃ©Ã©e: ${pr.data.html_url}`);
            
            // Ajouter l'URL de la PR en output
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `## ğŸ‰ Pull Request crÃ©Ã©e !
                
                La PR a Ã©tÃ© crÃ©Ã©e avec succÃ¨s : ${pr.data.html_url}
                
                Vous pouvez maintenant:
                1. Reviewer le code gÃ©nÃ©rÃ©
                2. Tester les modifications
                3. Merger la PR si tout est correct
                
                ---
                *AI Team Orchestrator*`
              });
            }
            
      - name: ğŸ’¬ Comment on Issue
        if: (github.event_name == 'issues' || github.event_name == 'issue_comment') && steps.apply.outputs.changes_made != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const agent = '${{ steps.analyze.outputs.agent }}';
            const taskSummary = '${{ steps.analyze.outputs.task_summary }}';
            const filesCreated = '${{ steps.apply.outputs.files_created }}';
            const changesMade = '${{ steps.apply.outputs.changes_made }}';
            
            let comment = `## ğŸ¤– AI Team a traitÃ© votre demande
            
            **Agent assignÃ©:** ${agent}
            **TÃ¢che:** ${taskSummary}
            
            `;
            
            if (changesMade === 'true') {
              comment += `âœ… **Code gÃ©nÃ©rÃ© avec succÃ¨s!**
              
              ğŸ“ **Fichiers crÃ©Ã©s:** ${filesCreated}
              
              ğŸ’¡ Le code a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement. Vous pouvez le consulter dans les fichiers crÃ©Ã©s.
              
              `;
            } else {
              comment += `âš ï¸ **Aucun fichier gÃ©nÃ©rÃ©**
              
              L'agent a analysÃ© la tÃ¢che mais n'a pas crÃ©Ã© de nouveaux fichiers.
              
              `;
            }
            
            comment += `---
            *GÃ©nÃ©rÃ© automatiquement par AI Team Orchestrator v1.2.5*`;
            
            if (context.payload.issue) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }
            
      - name: ğŸ‰ Success Notification
        run: |
          echo "ğŸ¤– AI Team has successfully processed the task!"
          echo "Agent: ${{ steps.analyze.outputs.agent }}"
          echo "Task: ${{ steps.analyze.outputs.task_summary }}"
          if [ "${{ steps.apply.outputs.changes_made }}" = "true" ]; then
            echo "Files created: ${{ steps.apply.outputs.files_created }}"
          fi 